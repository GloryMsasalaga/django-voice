{% extends 'docs/base.html' %}

{% block title %}Voice Command Interface | Django Documentation Voice Assistant{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card border-success">
                <div class="card-header text-white">
                    <h1 class="h3 mb-0">Voice Command Interface</h1>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <button id="startListening" class="btn btn-lg btn-primary">
                            <i class="bi bi-mic-fill"></i> Start Listening
                        </button>
                        <div id="status" class="mt-3 text-muted">Press the button and speak a command</div>
                    </div>

                    <div class="alert alert-info">
                        <h5 class="alert-heading">Available Voice Commands</h5>
                        <p>Start your command with "Kibena" followed by one of these commands:</p>
                        <ul>
                            <li><strong>"Kibena read [topic]"</strong> - Read documentation about a topic</li>
                            <li><strong>"Kibena search [query]"</strong> - Search the documentation for a query</li>
                            <li><strong>"Kibena translate to [language] [topic]"</strong> - Translate and read documentation in another language</li>
                            <li><strong>"Kibena help"</strong> - Show help information</li>
                        </ul>
                        <p>Examples:</p>
                        <ul>
                            <li>"Kibena read django templates"</li>
                            <li>"Kibena search models"</li>
                            <li>"Kibena translate to Swahili views"</li>
                        </ul>
                    </div>

                    <div id="commandText" class="card mb-4 d-none">
                        <div class="card-header bg-light">
                            <h2 class="h5 mb-0">Your Command</h2>
                        </div>
                        <div class="card-body">
                            <p id="recognizedText"></p>
                        </div>
                    </div>

                    <div id="responseContainer" class="card mb-4 d-none">
                        <div class="card-header bg-light">
                            <h2 class="h5 mb-0">Response</h2>
                        </div>
                        <div class="card-body">
                            <div id="responseText"></div>
                            
                            <div id="audioContainer" class="mt-4 d-none">
                                <audio id="audioPlayer" controls class="w-100">
                                    <source id="audioSource" src="" type="audio/mpeg">
                                    Your browser does not support the audio element.
                                </audio>
                                <div class="d-grid gap-2 mt-2">
                                    <button id="playButton" class="btn btn-primary">
                                        <i class="bi bi-play-fill"></i> Play Audio
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include the Web Speech API JavaScript -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const startButton = document.getElementById('startListening');
        const statusDiv = document.getElementById('status');
        const commandTextDiv = document.getElementById('commandText');
        const recognizedTextP = document.getElementById('recognizedText');
        const responseContainer = document.getElementById('responseContainer');
        const responseTextDiv = document.getElementById('responseText');
        const audioContainer = document.getElementById('audioContainer');
        const audioPlayer = document.getElementById('audioPlayer');
        const audioSource = document.getElementById('audioSource');
        const playButton = document.getElementById('playButton');
        
        // Check if browser supports speech recognition
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        
        if (!SpeechRecognition) {
            statusDiv.textContent = 'Speech recognition is not supported in your browser.';
            startButton.disabled = true;
            return;
        }
        
        const recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.lang = 'en-US';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;
        
        // Handle the result
        recognition.onresult = function(event) {
            const command = event.results[0][0].transcript.toLowerCase();
            recognizedTextP.textContent = command;
            commandTextDiv.classList.remove('d-none');
            
            // Process the command with the API
            processCommand(command);
        };
        
        // Error handling
        recognition.onerror = function(event) {
            statusDiv.textContent = 'Error occurred in recognition: ' + event.error;
            startButton.disabled = false;
        };
        
        // When recognition is done
        recognition.onend = function() {
            statusDiv.textContent = 'Voice recognition ended';
            startButton.disabled = false;
        };
        
        // Start listening button
        startButton.addEventListener('click', function() {
            startButton.disabled = true;
            statusDiv.textContent = 'Listening...';
            commandTextDiv.classList.add('d-none');
            responseContainer.classList.add('d-none');
            audioContainer.classList.add('d-none');
            
            // Start recognition
            recognition.start();
        });
        
        // Play button
        playButton.addEventListener('click', function() {
            audioPlayer.play();
        });
        
        // Process the command with the API
        function processCommand(command) {
            statusDiv.textContent = 'Processing command...';
            
            fetch('{% url "docs:process_voice_command" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ command: command }),
            })
            .then(response => response.json())
            .then(data => {
                responseContainer.classList.remove('d-none');
                
                if (data.success) {
                    // Handle successful command
                    if (typeof data.response === 'string') {
                        responseTextDiv.innerHTML = `<p>${data.response}</p>`;
                    } else if (Array.isArray(data.response)) {
                        // Handle search results
                        let html = '<ul>';
                        data.response.forEach(result => {
                            html += `<li><a href="/docs/section/${result.id}/">${result.title}</a></li>`;
                        });
                        html += '</ul>';
                        responseTextDiv.innerHTML = html;
                    } else {
                        responseTextDiv.innerHTML = `<p>${JSON.stringify(data.response)}</p>`;
                    }
                    
                    // Handle audio if provided
                    if (data.audio_url) {
                        audioSource.src = data.audio_url;
                        audioPlayer.load();
                        audioContainer.classList.remove('d-none');
                        // Optionally auto-play
                        audioPlayer.play();
                    }
                    
                    // Handle direct link to section
                    if (data.section_id) {
                        const lang = data.language || 'en';
                        const link = `<p><a href="/docs/section/${data.section_id}/?lang=${lang}" class="btn btn-success mt-3">Go to Full Content</a></p>`;
                        responseTextDiv.innerHTML += link;
                    }
                } else {
                    // Handle error
                    responseTextDiv.innerHTML = `<div class="alert alert-warning">${data.message || data.response || 'Error processing command'}</div>`;
                }
                
                statusDiv.textContent = data.message || 'Command processed';
            })
            .catch(error => {
                console.error('Error:', error);
                responseContainer.classList.remove('d-none');
                responseTextDiv.innerHTML = `<div class="alert alert-danger">Error processing command: ${error.message}</div>`;
                statusDiv.textContent = 'Error processing command';
            });
        }
    });
</script>
{% endblock %}
